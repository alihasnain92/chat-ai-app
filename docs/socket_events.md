# üîå Socket.IO Events Documentation

This document describes all real-time WebSocket events for the **Chat AI App** using Socket.IO.  
Events are organized by feature area with payload formats, direction, and error handling.

---

## üìã Table of Contents

1. [Connection & Authentication](#1-connection--authentication)
2. [Room Management](#2-room-management)
3. [Messaging Events](#3-messaging-events)
4. [Presence Events](#4-presence-events)
5. [Reaction Events](#5-reaction-events)

---

## 1. Connection & Authentication

### Event: `connection`

**Direction:** Client‚ÜíServer (automatic)

**Payload:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```
_Note: Token is sent via Socket.IO auth handshake during connection initialization._

**Handler behavior:**
1. Validates JWT token from handshake auth
2. Extracts user ID from token payload
3. Stores socket ‚Üí user mapping in memory
4. Marks user as online
5. Joins user to their personal room (`user:{userId}`)
6. Emits `authenticated` event back to client

**Emits:**
- `authenticated` (to client) on success
- `error` (to client) on authentication failure

**Error handling:**
```json
{
  "event": "error",
  "message": "Authentication failed: Invalid token",
  "code": "AUTH_FAILED"
}
```

---

### Event: `authenticated`

**Direction:** Server‚ÜíClient

**Payload:**
```json
{
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "socketId": "abc123def456",
  "timestamp": "2025-11-03T12:00:00Z"
}
```

**Handler behavior:**
Client receives confirmation of successful authentication and can now send other events.

**Emits:**
None (final event in authentication flow)

**Error handling:**
N/A (success event)

---

### Event: `disconnect`

**Direction:** Client‚ÜíServer (automatic)

**Payload:**
```json
{
  "reason": "client namespace disconnect"
}
```
_Note: Payload is automatically generated by Socket.IO._

**Handler behavior:**
1. Removes socket ‚Üí user mapping
2. Marks user as offline (after grace period of 30 seconds)
3. Leaves all rooms
4. Broadcasts `user:offline` event to relevant conversations
5. Cleans up presence data

**Emits:**
- `user:offline` (to conversation rooms)

**Error handling:**
Graceful cleanup; errors are logged but don't affect disconnection.

---

## 2. Room Management

### Event: `room:join`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

### Event: `room:leave`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

## 3. Messaging Events

### Event: `message:send`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

### Event: `message:receive`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

### Event: `message:status`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

### Event: `message:delivered`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

### Event: `message:read`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

## 4. Presence Events

### Event: `typing:start`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

### Event: `typing:stop`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

### Event: `user:online`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

### Event: `user:offline`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

## 5. Reaction Events

### Event: `reaction:add`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

### Event: `reaction:remove`

**Direction:** TODO

**Payload:**
TODO

**Handler behavior:**
TODO

**Emits:**
TODO

**Error handling:**
TODO

---

## üìù Connection Flow Diagram

```
Client                          Server
  |                               |
  |-- connection (with token) -->|
  |                               |--- Validate JWT
  |                               |--- Store socket mapping
  |                               |--- Mark user online
  |                               |--- Join personal room
  |                               |
  |<---- authenticated ----------|
  |                               |
  |                               |
  |   (exchange events)          |
  |<----------------------------->|
  |                               |
  |                               |
  |-- disconnect --------------->|
  |                               |--- Remove mapping
  |                               |--- Mark user offline (30s delay)
  |                               |--- Broadcast user:offline
  |                               |--- Clean up
```

---

## üîê Authentication Notes

- JWT token must be provided during Socket.IO connection handshake
- Token is validated on every connection attempt
- Invalid tokens result in immediate connection rejection
- Client should reconnect with fresh token if authentication fails

**Client connection example:**
```javascript
import { io } from 'socket.io-client';

const socket = io('http://localhost:3000', {
  auth: {
    token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
  }
});

socket.on('authenticated', (data) => {
  console.log('Connected as user:', data.userId);
});

socket.on('error', (error) => {
  console.error('Socket error:', error);
});
```

---

## üì° Room Naming Conventions

- **User personal rooms:** `user:{userId}`
- **Conversation rooms:** `conversation:{conversationId}`
- **Presence rooms:** `presence:{userId}` (for typing indicators)

---

## ‚ö†Ô∏è Common Error Codes

| Code | Description |
|------|-------------|
| `AUTH_FAILED` | Invalid or expired JWT token |
| `UNAUTHORIZED` | User not authorized for this action |
| `ROOM_NOT_FOUND` | Conversation/room does not exist |
| `INVALID_PAYLOAD` | Malformed event payload |
| `RATE_LIMIT` | Too many events sent in short time |
| `SERVER_ERROR` | Unexpected server error |

---

**Maintained by:** chat-ai-app team  
**Last updated:** November 2025  
**Status:** üöß Work in Progress - Connection flow complete, other events marked as TODO